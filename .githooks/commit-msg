#!/usr/bin/env bash
set -euo pipefail

# Auto-bump VERSION based on the commit message type.
# Rules:
# - release => major bump
# - >100 files changed => minor bump
# - feat/ux/refactor/perf => minor bump
# - everything else => patch bump

if [[ "${SKIP_VERSION_BUMP:-}" == "1" ]]; then
  exit 0
fi

msg_file="${1:-}"
if [[ -z "$msg_file" || ! -f "$msg_file" ]]; then
  exit 0
fi

first_line="$(head -n 1 "$msg_file" | tr -d '\r')"
if [[ "$first_line" == Merge* ]]; then
  exit 0
fi

type="$(printf '%s' "$first_line" | sed -nE 's/^([a-z]+)(\([^)]+\))?:.*/\1/p')"
if [[ -z "$type" ]]; then
  type="patch"
fi

version_file="VERSION"
if [[ ! -f "$version_file" ]]; then
  echo "V 1.00.00" > "$version_file"
fi

raw="$(tr -d '\r' < "$version_file")"
raw="${raw#V }"
raw="${raw#v }"
IFS='.' read -r major minor patch <<< "$raw"

major="${major:-1}"
minor="${minor:-0}"
patch="${patch:-0}"

re='^[0-9]+$'
if [[ ! "$major" =~ $re ]]; then major=1; fi
if [[ ! "$minor" =~ $re ]]; then minor=0; fi
if [[ ! "$patch" =~ $re ]]; then patch=0; fi

bump="patch"
if [[ "$type" == "release" ]]; then
  bump="major"
else
  file_count="$(git diff --cached --name-only | sed '/^$/d' | wc -l | tr -d ' ')"
  file_count="${file_count:-0}"
  if [[ "$file_count" -gt 100 ]]; then
    bump="minor"
  else
    case "$type" in
      feat|ux|refactor|perf) bump="minor" ;;
      *) bump="patch" ;;
    esac
  fi
fi

if [[ "$bump" == "major" ]]; then
  major=$((major + 1))
  minor=0
  patch=0
elif [[ "$bump" == "minor" ]]; then
  minor=$((minor + 1))
else
  patch=$((patch + 1))
fi

if [[ "$minor" -gt 99 ]]; then
  minor=0
  major=$((major + 1))
  patch=0
fi

new_version="$(printf "V %d.%02d.%02d" "$major" "$minor" "$patch")"
current_version="$(tr -d '\r' < "$version_file")"
if [[ "$new_version" == "$current_version" ]]; then
  exit 0
fi

printf "%s\n" "$new_version" > "$version_file"

git_dir="$(git rev-parse --git-path .)"
printf "%s\n" "$new_version" > "$git_dir/version-bump"
